name: ðŸš€ Deploy Flask App to EC2

on:
  push:
    branches:
      - main  # Cháº¡y khi cÃ³ thay Ä‘á»•i trÃªn nhÃ¡nh main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸš€ Káº¿t ná»‘i SSH vÃ  triá»ƒn khai
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_KEY }}
        script: |
          echo "ðŸ”„ Äang cáº­p nháº­t server..."
          sudo apt update && sudo apt upgrade -y
          sudo apt install python3.12-venv -y

          echo "ðŸ“‚ Äá»“ng bá»™ code vá»›i EC2"
          rsync -av --exclude='.git' --exclude='ec2_env' $GITHUB_WORKSPACE ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/home/${{ secrets.AWS_USER }}/myapp

          echo "ðŸ”§ Thiáº¿t láº­p Virtual Environment"
          cd /home/${{ secrets.AWS_USER }}/flask-api
          python3 -m venv ec2_env
          source ec2_env/bin/activate

          echo "ðŸ“¦ CÃ i Ä‘áº·t dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "ðŸš€ Khá»Ÿi Ä‘á»™ng láº¡i á»©ng dá»¥ng"
          pkill -f app.py || true
          nohup python app.py > app.log 2>&1 &
          
          echo "âœ… Deployment hoÃ n táº¥t!"
