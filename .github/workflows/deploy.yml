name: 🚀 Deploy Flask App to EC2

on:
  push:
    branches:
      - main  # Chạy khi có thay đổi trên nhánh main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🚀 Kết nối SSH và triển khai
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_KEY }}
        script: |
          echo "🔄 Đang cập nhật server..."
          sudo apt update && sudo apt upgrade -y
          sudo apt install python3.12-venv -y

          echo "📂 Đồng bộ code với EC2"
          rsync -av --exclude='.git' --exclude='ec2_env' $GITHUB_WORKSPACE ${{ secrets.AWS_USER }}@${{ secrets.AWS_HOST }}:/home/${{ secrets.AWS_USER }}/myapp

          echo "🔧 Thiết lập Virtual Environment"
          cd /home/${{ secrets.AWS_USER }}/flask-api
          python3 -m venv ec2_env
          source ec2_env/bin/activate

          echo "📦 Cài đặt dependencies"
          pip install --upgrade pip
          pip install -r requirements.txt

          echo "🚀 Khởi động lại ứng dụng"
          pkill -f app.py || true
          nohup python app.py > app.log 2>&1 &
          
          echo "✅ Deployment hoàn tất!"
